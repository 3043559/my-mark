# CPU调度

## 调度的概念
CPU调度：是对CPU进行分配，从就绪队列中按照一定的算法（公平、高效的原则）选择一个进程，并分配CPU运行，以实现进程并发地执行
- 是多道程序操作系统的基础
- 是操作系统设计的核心问题

### 调度的层次

作业：一个具体的任务，需要启动的程序
 
|                | 任务                                       | 调度发生在      | 发生频 率 | 对进程状态的影响         |
| -------------- | ---------------------------------------- | ---------- | ----- | ---------------- |
| 高级调度<br>(作业调度) | 按照某种规则<br>从后备队列中选择合适的作业将其调入内存<br>并为其创建进程 | 外存(作业)->内存 | 最低    | 无->创建态->就绪态      |
| 中级调度<br>(内存调度) | 按照某种规则<br>从挂起队列中选择合适的进程<br>将其数据调回内存      | 外存(进程)->内存 | 中等    | (阻塞挂起->)挂起态->就绪态 |
| 低级调度           | 按照某种规则<br>从就绪队列中选择一个进程<br>为其分配处理机        | 内存->CPU    | 最高    | 就绪态->运行态(进程)     |

#### 高级调度

**高级调度(作业调度)**：按一定的原则从外存的作业后备队列中挑选一个作业调入内存，并创建进程
- *每个作业调入一次，调出一次*
- 作业调入时建立PCB，调出时撤销PCB
- *外存(作业)-->内存*
- *无-->创建态-->就绪态*

#### 中级调度

**中级调度(内存调度)**：——按照某种策略决定将哪个处于*挂起状态*的进程重新调入内存
- 调度*频率度较高*：一个进程可能会被多次调出、调入内存
- *外存(进程)-->内存*
- *(阻塞挂起-->)挂起态-->就绪态*

##### 挂起状态

*挂起状态(挂起态)*：暂时调到外存等待的进程
- 内存不够时，将某些进程的数据调出外存，等内存空闲或者进程需要运行时重新调入内存

*挂起队列*：多个挂起的进程PCB所组成的结构


#### 低级调度

**低级调度(进程调度/处理机调度)**：按照某种策略，从就绪队列中选取一个进程，并分配处理机
- 是操作系统中最基本的一种调度：在一般的操作系统中都必须配置进程调度
- 调度*频率很高*：一般几十毫秒一次
- *内存-->CPU*
- *就绪态-->运行态*


## 调度的实现

### 进程调度的时机
- **需要进行**进程调度与切换俺的情况
  - 当前运行的进程**主动放弃**处理机
    - 进程正常终止
    - 运行过程中发生异常而终止
    - 进程主动请求阻塞
  - 当前进程的进程*被动放弃*处理机
    - 分给进程的时间片用完
    - 有更紧急的事情要处理
    - 有更高优先级的进程进入就绪队列
- **不能进行**进程调度与切换的情况
  - 在**处理中断的过程**中：中断处理过程复杂，与硬件密切相关，很难做到在中断处理过程中进行进程切换
  - 进程在*操作系统内核程序临界区*中
  - 在*原子操作过程*中(原语)：原子操作不可中断
    - 如修改PCB中进程状态标志，并把PCB放到相应队列

> [!tip] 临界资源与临界区
> - **临界资源(互斥资源)**：一个时间段内，只允许一个进程使用的资源
> - **临界区**：访问临界资源的代码段
> - **内核程序临界区**：用来访问某种内核数据结构的代码段
>   - 进程的就绪队列：由各就绪进程的PCB组成

### 进程调度的方式
#### 非剥夺调度方式
**非剥夺调度方式(非抢占方式)**：进程需自行结束或请求暂停，即使有更紧急任务，当前进程也会被强制中断
- 适合于早期的批处理系统
- 优点：实现简单
- 缺点：系统开销小但是无法及时处理紧急任务

#### 剥夺调度方式
**剥夺调度方式(抢占方式)**：若更紧急的进程出现，正在执行的进程会被立即暂停，并让出处理机
- 适合于分时操作系统、实时操作系统
- 优点
  - 可以优先处理更紧急的进程
  - 可实现让各进程按时间片轮流执行的功能（通过时钟中断）

### 进程的切换与过程
#### 进程调度与进程切换的概念

**广义的进程调度**：包含了*选择一个进程*和*进程切换*两个步骤

**狭义的进程调度**：指的是从就绪队列中*选中一个要运行的进程*
- 选中刚被暂停执行的进程：不需要进程切换
- 选中另一个进程：需要进程切换

**进程切换**：是指一个进程让出处理机，由另一个进程占用处理机的过程

#### 进程切换的过程
- 对原来运行进程各种数据的保存
- 对新的进程各种数据的恢复：一般保存在进程控制块中的处理机现场信息
  - 程序计数器
  - 程序状态字
  - 各种数据寄存器
  - ……

> [!warning] 注意
> - **进程切换是有代价的**：*频繁*的进程*调度和切换*，减少了每个进程的执行时间，从而*降低了系统效率*。


### 调度程序

**调度程序(调度器/Scheduler)**：用于调度和分派CPU的组件，决定*调度算法*和*时间片大小*
- 非抢占式调度策略：只有运行进程阻塞或退出才触发调度程序工作
- 抢占方式调度策略：每个时钟中断或k个时钟中断会触发调度程序工作

>[!warning] 注意
>- 操作系统不支持内核级线程：调度程序的处理对象是进程
>- 操作系统支持内核级线程：调度程序的处理对象是内核线

#### 闲逛进程

**闲逛进程(Idle Process)**：当就绪队列中没有就绪进程时，系统所运行的进程
- 优先级最低
- 可以是0地址指令，占用一个完整的指令周期，指令周期末尾例行检查中断
- 能耗低
- PID为0

## 调度的目标

### CPU利用率
**CPU利用率**：指CPU“忙碌”的时间占总时间的比例
$$
\text{{\color{Red}CPU的利用率}}= \frac{\text{CPU有效工作时间}}{\text{CPU有效工作时间}+\text{CPU空闲等待时间}} 
$$

### 系统吞吐量

**系统吞吐量**：单位时间内CPU完成作业的数量

$$
\text{{\color{Red}系统吞吐量}}= \frac{\text{总共完成的作业}}{\text{总共花费了多少时间}} 
$$

### 周转时间
**周转时间**

**等待时间**

**响应时间**

